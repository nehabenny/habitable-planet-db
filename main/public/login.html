<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Cartography - Authentication</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a0a14; color: white; }
        
        #background-gif {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        #background-gif img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.8;
        }

        .auth-view { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; justify-content: center; align-items: center; }
        
        .auth-container { 
            background: rgba(17, 24, 39, 0.7);
            padding: 30px; 
            border-radius: 12px; 
            width: 400px; 
            border: 1px solid rgba(255,255,255,0.1); 
            backdrop-filter: blur(5px);
        }

        /* Updated h2 style to use the new Bebas Neue font */
        .auth-container h2 { 
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem; /* Increased size for impact */
            font-weight: 400;
            margin-bottom: 20px; 
            text-align: center; 
            letter-spacing: 0.05em; /* A little spacing for style */
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a7b5; }
        
        .form-input, .form-select { 
            width: 100%; 
            background: #1f2937; 
            border: 1px solid #374151; 
            color: white; 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 1rem; 
        }
        .form-button { 
            width: 100%; 
            background: #4f46e5; 
            color: white; 
            padding: 12px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            transition: background-color 0.3s; 
        }
        .form-button:hover { background-color: #635bff; }
        .choice-button { 
            width: 100%; 
            padding: 16px; 
            margin-bottom: 1rem; 
            border-radius: 8px; 
            text-align: center; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background-color 0.3s; 
        }
        .viewer-btn { background-color: #4f46e5; }
        .viewer-btn:hover { background-color: #635bff; }
        .researcher-btn { background-color: #374151; }
        .researcher-btn:hover { background-color: #4b5563; }
        .form-error { color: #ef4444; font-size: 0.875rem; margin-top: 10px; min-height: 1.25rem; }
        .form-success { color: #22c55e; font-size: 0.875rem; margin-top: 10px; min-height: 1.25rem; }
        .auth-toggle-link { background: none; border: none; color: #9ca3af; font-size: 0.9rem; cursor: pointer; margin-top: 15px; text-align: center; display: block; width: 100%; }
        .auth-toggle-link:hover { color: #d1d5db; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="background-gif">
        <img src="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExZnRzdXAwYWhkNXplcDVzdWRnZ3ZhZzRwOTl0eHdndnExd2ZuNHY1biZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/sJvz8Qnfly3BOuotGx/giphy.gif" alt="Animated space background">
    </div>

    <div class="auth-view">
        <div id="main-auth-container" class="auth-container">
            <div id="choice-view">
                <h2>Welcome to Celestial Voyager üöÄ</h2>
                <button id="viewer-btn" class="choice-button viewer-btn">Explore as a Viewer</button>
                <button id="researcher-btn" class="choice-button researcher-btn">Researcher Login</button>
            </div>

            <div id="login-form-container" class="hidden">
                <h2>Researcher Login</h2>
                <form id="login-form">
                    <div class="form-group"><label for="login-username">Username</label><input type="text" id="login-username" class="form-input" required></div>
                    <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" class="form-input" required></div>
                    <button type="submit" class="form-button">Access Interface</button>
                    <p id="login-error" class="form-error"></p><p id="login-success" class="form-success"></p>
                    <button type="button" id="show-register-form" class="auth-toggle-link">Create a researcher account</button>
                    <button type="button" class="auth-toggle-link back-to-choice">‚Üê Back</button>
                </form>
            </div>

            <div id="register-form-container" class="hidden">
                <h2>Create Researcher Account</h2>
                <form id="register-form">
                    <div class="form-group"><label for="register-username">Username</label><input type="text" id="register-username" class="form-input" required></div>
                    <div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" class="form-input" required></div>
                    <input type="hidden" id="register-role" value="researcher">
                    <button type="submit" class="form-button">Register</button><p id="register-error" class="form-error"></p>
                    <button type="button" id="show-login-form" class="auth-toggle-link">Already have an account? Login</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        
        const choiceView = document.getElementById('choice-view');
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginErrorEl = document.getElementById('login-error');
        const loginSuccessEl = document.getElementById('login-success');
        const registerErrorEl = document.getElementById('register-error');

        document.getElementById('viewer-btn').addEventListener('click', () => {
            const header = btoa(JSON.stringify({ alg: 'none', typ: 'JWT' }));
            const payload = btoa(JSON.stringify({ role: 'viewer', guest: true }));
            const guestToken = `${header}.${payload}.`;
            localStorage.setItem('authToken', guestToken);
            window.location.href = './za.html';
        });

        document.getElementById('researcher-btn').addEventListener('click', () => {
            choiceView.classList.add('hidden');
            loginFormContainer.classList.remove('hidden');
        });

        document.querySelectorAll('.back-to-choice').forEach(btn => {
            btn.addEventListener('click', () => {
                loginFormContainer.classList.add('hidden');
                registerFormContainer.classList.add('hidden');
                choiceView.classList.remove('hidden');
            });
        });

        document.getElementById('show-register-form').addEventListener('click', () => {
            loginFormContainer.classList.add('hidden');
            registerFormContainer.classList.remove('hidden');
            loginErrorEl.textContent = '';
            loginSuccessEl.textContent = '';
        });
        
        function showLoginForm(successMessage = "") {
            registerFormContainer.classList.add('hidden');
            loginFormContainer.classList.remove('hidden');
            choiceView.classList.add('hidden');
            registerErrorEl.textContent = '';
            loginSuccessEl.textContent = successMessage;
        }

        document.getElementById('show-login-form').addEventListener('click', () => showLoginForm());

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginErrorEl.textContent = '';
            loginSuccessEl.textContent = '';
            try {
                const res = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: e.target.elements['login-username'].value,
                        password: e.target.elements['login-password'].value
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Login failed');
                localStorage.setItem('authToken', data.token);
                window.location.href = './za.html';
            } catch (err) {
                loginErrorEl.textContent = err.message;
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            registerErrorEl.textContent = '';
            loginSuccessEl.textContent = '';
            try {
                const payload = {
                    username: e.target.elements['register-username'].value,
                    password: e.target.elements['register-password'].value,
                    role: e.target.elements['register-role'].value
                };
                const res = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Registration failed');
                registerForm.reset();
                showLoginForm("Registration successful! Please log in.");
            } catch (err) {
                registerErrorEl.textContent = err.message;
            }
        });
    </script>
</body>
</html>